name: Rust CI
on:
  push:
    branches: [main, develop]
    paths:
      - "src/rust/**"
      - ".github/workflows/ci-rust.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/rust/**"
      - ".github/workflows/ci-rust.yml"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"

defaults:
  run:
    working-directory: src/rust

jobs:
  extract-msrv:
    runs-on: ubuntu-latest
    outputs:
      msrv: ${{ steps.msrv.outputs.value }}
    steps:
      - uses: actions/checkout@v4
      - id: msrv
        run: |
          MSRV=$(awk -F'"' '/rust-version/ {print $2; exit 0}' Cargo.toml || echo "1.87.0")
          echo "value=$MSRV" >> $GITHUB_OUTPUT
          echo "MSRV extracted: $MSRV"

  fmt:
    name: üî§ Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: üîç Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2 # ‚úÖ Valid cache action
      - run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: üß™ Tests
    runs-on: ${{ matrix.os }}
    needs: extract-msrv
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        toolchain: [stable, msrv]
        include:
          - toolchain: msrv
            rust: ${{ needs.extract-msrv.outputs.msrv }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust == 'stable' && 'stable' || needs.extract-msrv.outputs.msrv }}
      - uses: Swatinem/rust-cache@v2
      - name: Tests
        run: cargo test --workspace --all-features --verbose
      - name: Doc tests
        if: matrix.os == 'ubuntu-latest'
        run: cargo test --workspace --doc --all-features

  docs:
    name: üìö Docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Check
        run: cargo doc --workspace --all-features --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  examples:
    name: üí° Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build & Run Examples
        run: |
          # Basic (no features)
          cargo build --example basic --package prjenv
          cargo run --example basic --package prjenv

          # Advanced (full - integration test)
          cargo build --example advanced --package prjenv --features full
          cargo run --example advanced --package prjenv --features full

  coverage:
    name: üìä Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@cargo-llvm-cov
      - name: Generate
        run: cargo llvm-cov --workspace --all-features --lcov --output-path lcov.info
      - name: Upload
        uses: codecov/codecov-action@v4
        with:
          files: ./lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}

  success:
    name: ‚úÖ Complete
    runs-on: ubuntu-latest
    needs: [fmt, clippy, test, docs, examples, coverage]
    if: always()
    steps:
      - name: Status
        run: |
          RESULTS=($(echo '${{ toJSON(needs) }}' | jq -r 'to_entries[] | select(.value.result != "success") | .key'))
          if [ ${#RESULTS[@]} -gt 0 ]; then
            echo "‚ùå Failed jobs: ${RESULTS[*]}"
            exit 1
          fi
          echo "‚úÖ All jobs passed!"
